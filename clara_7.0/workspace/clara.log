INFO clara.agents.context - Entered run_single() with page_path=WindowsPath('workspace/uploads/083434c43fdc4ef69034d48b5ccc7e16_page_1.pdf'), prev_content=None
INFO clara.agents.context - Invoking chat_json with system_prompt, user_prompt, schema, files
INFO clara.ai.gemini_client - Sending request to Gemini AI: url='https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=AIzaSyAzCHjN2BVqfIQY6Tf98d4uUZbhdY0CSms', payload={'contents': [{'role': 'user', 'parts': [{'text': "You are an expert document context analyzer. You will receive the content of a single page of a document (either text or a description of an image page), and optionally the previous page's content. First, perform a structural analysis of the page (e.g., layout, presence of tables, images, headers, footers, etc.). Then, provide a concise summary of the page's context (e.g., what type of content is present, such as 'front of ID card', 'invoice details', 'blank page', etc.). Finally, determine if this page is a fresh start or a continuation of the previous page, using all available cues including text, layout, and visual content. Return a JSON object with three fields: 'structural_analysis' (string), 'page_context' (string), and 'continuation' (boolean, true if the page is a continuation, false if it is a fresh page). The first page is always false for 'continuation'.\nUser input:\nCurrent page content:\n[Non-text file: 083434c43fdc4ef69034d48b5ccc7e16_page_1.pdf]\n\nPrevious page content:\n\nReturn JSON matching this schema: {'structural_analysis': 'string', 'page_context': 'string', 'continuation': 'boolean'}"}, {'text': '[Non-text file: 083434c43fdc4ef69034d48b5ccc7e16_page_1.pdf]'}]}]}
INFO clara.agents.context - Entered run_single() with page_path=WindowsPath('workspace/uploads/083434c43fdc4ef69034d48b5ccc7e16_page_2.pdf'), prev_content=''
INFO clara.agents.context - Invoking chat_json with system_prompt, user_prompt, schema, files
INFO clara.ai.gemini_client - Sending request to Gemini AI: url='https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=AIzaSyAzCHjN2BVqfIQY6Tf98d4uUZbhdY0CSms', payload={'contents': [{'role': 'user', 'parts': [{'text': "You are an expert document context analyzer. You will receive the content of a single page of a document (either text or a description of an image page), and optionally the previous page's content. First, perform a structural analysis of the page (e.g., layout, presence of tables, images, headers, footers, etc.). Then, provide a concise summary of the page's context (e.g., what type of content is present, such as 'front of ID card', 'invoice details', 'blank page', etc.). Finally, determine if this page is a fresh start or a continuation of the previous page, using all available cues including text, layout, and visual content. Return a JSON object with three fields: 'structural_analysis' (string), 'page_context' (string), and 'continuation' (boolean, true if the page is a continuation, false if it is a fresh page). The first page is always false for 'continuation'.\nUser input:\nCurrent page content:\n[Non-text file: 083434c43fdc4ef69034d48b5ccc7e16_page_2.pdf]\n\nPrevious page content:\n\nReturn JSON matching this schema: {'structural_analysis': 'string', 'page_context': 'string', 'continuation': 'boolean'}"}, {'text': '[Non-text file: 083434c43fdc4ef69034d48b5ccc7e16_page_2.pdf]'}]}]}
ERROR clara.ai.gemini_client - Error parsing Gemini AI response: HTTPStatusError("Client error '429 Too Many Requests' for url 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=AIzaSyAzCHjN2BVqfIQY6Tf98d4uUZbhdY0CSms'\nFor more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429")
Traceback (most recent call last):
  File "D:\CLB_AGENT_WORKSPACE\clara_7.0\src\clara\ai\gemini_client.py", line 71, in chat_json
    resp.raise_for_status()
  File "D:\CLB_AGENT_WORKSPACE\clara_7.0\.venv\Lib\site-packages\httpx\_models.py", line 761, in raise_for_status
    raise HTTPStatusError(message, request=request, response=self)
httpx.HTTPStatusError: Client error '429 Too Many Requests' for url 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=AIzaSyAzCHjN2BVqfIQY6Tf98d4uUZbhdY0CSms'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429
INFO clara.agents.context - AI response: {'error': 'Could not parse AI response', 'raw': {'error': {'code': 429, 'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits.', 'status': 'RESOURCE_EXHAUSTED', 'details': [{'@type': 'type.googleapis.com/google.rpc.QuotaFailure', 'violations': [{'quotaMetric': 'generativelanguage.googleapis.com/generate_content_free_tier_requests', 'quotaId': 'GenerateRequestsPerDayPerProjectPerModel-FreeTier', 'quotaDimensions': {'location': 'global', 'model': 'gemini-1.5-flash'}, 'quotaValue': '50'}]}, {'@type': 'type.googleapis.com/google.rpc.Help', 'links': [{'description': 'Learn more about Gemini API quotas', 'url': 'https://ai.google.dev/gemini-api/docs/rate-limits'}]}, {'@type': 'type.googleapis.com/google.rpc.RetryInfo', 'retryDelay': '27s'}]}}}
INFO clara.agents.context - Exiting run_single() with result: AgentResult(success=True, data={'error': 'Could not parse AI response', 'raw': {'error': {'code': 429, 'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits.', 'status': 'RESOURCE_EXHAUSTED', 'details': [{'@type': 'type.googleapis.com/google.rpc.QuotaFailure', 'violations': [{'quotaMetric': 'generativelanguage.googleapis.com/generate_content_free_tier_requests', 'quotaId': 'GenerateRequestsPerDayPerProjectPerModel-FreeTier', 'quotaDimensions': {'location': 'global', 'model': 'gemini-1.5-flash'}, 'quotaValue': '50'}]}, {'@type': 'type.googleapis.com/google.rpc.Help', 'links': [{'description': 'Learn more about Gemini API quotas', 'url': 'https://ai.google.dev/gemini-api/docs/rate-limits'}]}, {'@type': 'type.googleapis.com/google.rpc.RetryInfo', 'retryDelay': '27s'}]}}}, metrics=None, message=None)
ERROR clara.ai.gemini_client - Error parsing Gemini AI response: HTTPStatusError("Client error '429 Too Many Requests' for url 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=AIzaSyAzCHjN2BVqfIQY6Tf98d4uUZbhdY0CSms'\nFor more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429")
Traceback (most recent call last):
  File "D:\CLB_AGENT_WORKSPACE\clara_7.0\src\clara\ai\gemini_client.py", line 71, in chat_json
    resp.raise_for_status()
  File "D:\CLB_AGENT_WORKSPACE\clara_7.0\.venv\Lib\site-packages\httpx\_models.py", line 761, in raise_for_status
    raise HTTPStatusError(message, request=request, response=self)
httpx.HTTPStatusError: Client error '429 Too Many Requests' for url 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=AIzaSyAzCHjN2BVqfIQY6Tf98d4uUZbhdY0CSms'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429
INFO clara.agents.context - AI response: {'error': 'Could not parse AI response', 'raw': {'error': {'code': 429, 'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits.', 'status': 'RESOURCE_EXHAUSTED', 'details': [{'@type': 'type.googleapis.com/google.rpc.QuotaFailure', 'violations': [{'quotaMetric': 'generativelanguage.googleapis.com/generate_content_free_tier_requests', 'quotaId': 'GenerateRequestsPerDayPerProjectPerModel-FreeTier', 'quotaDimensions': {'location': 'global', 'model': 'gemini-1.5-flash'}, 'quotaValue': '50'}]}, {'@type': 'type.googleapis.com/google.rpc.Help', 'links': [{'description': 'Learn more about Gemini API quotas', 'url': 'https://ai.google.dev/gemini-api/docs/rate-limits'}]}, {'@type': 'type.googleapis.com/google.rpc.RetryInfo', 'retryDelay': '27s'}]}}}
INFO clara.agents.context - Exiting run_single() with result: AgentResult(success=True, data={'error': 'Could not parse AI response', 'raw': {'error': {'code': 429, 'message': 'You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits.', 'status': 'RESOURCE_EXHAUSTED', 'details': [{'@type': 'type.googleapis.com/google.rpc.QuotaFailure', 'violations': [{'quotaMetric': 'generativelanguage.googleapis.com/generate_content_free_tier_requests', 'quotaId': 'GenerateRequestsPerDayPerProjectPerModel-FreeTier', 'quotaDimensions': {'location': 'global', 'model': 'gemini-1.5-flash'}, 'quotaValue': '50'}]}, {'@type': 'type.googleapis.com/google.rpc.Help', 'links': [{'description': 'Learn more about Gemini API quotas', 'url': 'https://ai.google.dev/gemini-api/docs/rate-limits'}]}, {'@type': 'type.googleapis.com/google.rpc.RetryInfo', 'retryDelay': '27s'}]}}}, metrics=None, message=None)
ERROR clara.ai.gemini_client - AI disabled or missing key
